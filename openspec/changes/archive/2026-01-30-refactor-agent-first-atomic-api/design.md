# Design: Agent 优先的原子化 API 与组合模型

## Context

- 本工具为自用 GitLab CLI，已具备 project、pipeline、branch、mr、tag 等能力，使用 Cobra + Viper，通过 GitLab REST API 交互。
- 使用者包括人类与 AI Agent（通过 Cursor/Claude 等与 skills 结合）。当前 Agent 使用方式依赖 SKILL.md 中的命令示例，缺少稳定、可解析的输出与明确的「原子 + 组合」模型，难以系统化编排。
- 目标：在不大幅重写的前提下，形成「原子命令层 + 组合/工作流」的清晰边界，便于 Agent 与技能快速、可靠地调用与组合。

## Goals / Non-Goals

- **Goals**
  - 定义并文档化「原子命令集」作为单一事实来源（文档 + 必要时 CLI 可发现）。
  - 为原子命令提供可选的机器可读输出（如 `--json`）与稳定退出码。
  - 在文档与 Skill 中沉淀组合模式与典型工作流，便于 Agent 按场景组合。
- **Non-Goals**
  - 不在本阶段实现新的 GitLab API 域（如 Issues、Commit 详情 API 等）或新的高层「工作流子命令」；组合优先以文档与 Skill 指引为主。
  - 不改变默认人类可读输出的格式与语言（中文提示保持不变）；仅新增可选机器输出与文档结构。

## Decisions

### 1. 原子命令的定义与范围

- **原子命令**：对应 GitLab/git 概念的最小操作单元，一次调用完成一个可描述的动作（如「列出项目」「获取单条 Pipeline」「比较两分支」「创建 MR」）。
- **范围**：以当前已实现的命令为基准，筛选并文档化为「原子集」：例如 `project list/get`、`pipeline list/get/latest/check-schedule`、`branch list/diff`、`mr list/create/merge`、`tag list/create/delete`。不新增域，只做边界明确与命名/分组统一。
- **原则**：每个原子命令保持单一职责；过滤、分页等用现有标志（如 `--status`、`--limit`）表达，不拆成多个子命令。

### 2. 机器可读输出（如 `--json`）

- **方式**：在现有子命令上增加全局或每命令可选的 `--json`（或等价）标志；当设置时，将主要结果以 JSON 输出到 stdout，错误信息也以结构化字段或固定格式输出到 stderr。
- **格式**：使用简单、稳定的 JSON 结构（对象或数组），字段与当前人类可读输出中的关键信息对应（如 id、状态、URL、时间戳）；不要求与 GitLab API 响应一一对应，以「足够 Agent 解析与决策」为准。
- **兼容**：默认不启用；未传 `--json` 时行为与现有一致，不影响现有脚本。

### 3. 退出码约定

- **0**：执行成功，结果有效（可能为空列表）。
- **1**：业务或 API 错误（如项目不存在、无权限、MR 已合并）。
- **2**：用法错误（缺少必填参数、非法标志等）。
- 子命令与全局错误处理统一采用上述约定，便于 Agent 与 shell 脚本分支判断。

### 4. 组合与工作流

- **组合方式**：优先「管道 + 顺序调用」：Agent 或脚本先调用原子 A，解析输出（如项目 ID/路径），再调用原子 B。不在本阶段实现内置的「工作流引擎」或新高层子命令。
- **文档**：在 README 或独立 doc 中增加「工作流/组合示例」章节，列出 3～5 个典型场景（如：发现项目 → 看分支 → 比较差异 → 创建 MR；或：查最新 Pipeline → 按状态过滤）。SKILL.md 中显式区分「原子命令」与「推荐组合」，并指向文档。
- **可发现性**：通过 `gitlab-tools --help` 与各子命令 `--help` 保持清晰；可选提供 `gitlab-tools capabilities` 或类似子命令，输出原子能力列表（名称 + 简短描述），便于 Agent 发现。

### 5. Skill 与文档结构

- **SKILL.md**：按「原子命令」与「组合示例」重组；原子命令表列出命令、主要参数与典型用途；组合示例给出 1～2 行命令链或步骤说明，并注明可解析 `--json` 以便编排。
- **README**：保留现有使用示例；新增「Agent 与脚本使用」小节，说明 `--json`、退出码及工作流文档入口。

## Risks / Trade-offs

- **JSON 与人类输出并存**：实现时需避免重复逻辑导致漂移；建议输出层统一通过「格式化器」生成人类/JSON 两种格式，减少分支。
- **原子集文档与实现不同步**：将原子命令集写在 openspec 与 README/SKILL 中，作为契约；后续新增命令时需同步更新「原子集」列表。

## Migration Plan

- 无破坏性变更：不加必须使用的新必填参数，默认行为不变。
- 分步实施：先落实原子集文档与退出码约定；再为各子命令增加 `--json`；最后补充工作流文档与 SKILL 重组。
- 回滚：若需回滚，仅移除 `--json` 与新增文档即可，不影响现有用法。

## Open Questions

- 是否在本阶段增加 `gitlab-tools capabilities`（或等价的）子命令，用于输出原子能力列表，供 Agent 发现？（建议：可选实现，列在 tasks 中为可选任务。）
